name: "CodeQL Advanced"

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  schedule:
    - cron: '43 4 * * 2'

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}

    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: actions
          build-mode: none
        - language: java-kotlin
          build-mode: manual
        # ➕ tu peux remettre swift ici si besoin :
        # - language: swift
        #   build-mode: autobuild

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      if: matrix.language == 'java-kotlin'
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17
        
    - name: Set up Android SDK
      if: matrix.language == 'java-kotlin'
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        mkdir -p "$HOME/android-sdk/cmdline-tools"
        cd "$HOME/android-sdk/cmdline-tools"
    
        # Téléchargement et installation des tools
        wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdtools.zip
        unzip -q cmdtools.zip -d latest
    
        # Installation du SDK minimal requis
        yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=$HOME/android-sdk "platforms;android-34" "build-tools;34.0.0" "platform-tools"
    
        # Détermine le bon dossier Android (racine ou sous-dossier)
        if [ -d "./android" ]; then
          target_dir="./android"
        elif [ -d "./app_farmbot/android" ]; then
          target_dir="./app_farmbot/android"
        else
          mkdir -p ./android
          target_dir="./android"
        fi
    
        echo "sdk.dir=$HOME/android-sdk" > "$target_dir/local.properties"
        echo "[INFO] Created local.properties at $target_dir/local.properties"



    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}

    # --- Manual build step for Kotlin/Android ---
    - if: matrix.language == 'java-kotlin'
      name: Build Android app
      run: |
        chmod +x ./gradlew || true
        ./gradlew clean assembleDebug -x lint -x test

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{ matrix.language }}"
